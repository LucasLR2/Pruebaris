<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebaris - Inicio</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="login-page">
    <div class="background-overlay"></div>

    <div class="container">
        <div class="login-box">
            <!-- Pantalla principal -->
            <div id="mainScreen" class="screen active">
                <div class="logo">
                    <img src="resources/Logo-sf.png" alt="Pruebaris">
                </div>

                <div class="file-drop-area">
                    <label for="fileInputMain" class="file-drop-label">
                        <p class="drop-text">Arrastra tu archivo JSON aquí</p>
                        <p class="drop-subtext">o haz clic para seleccionar</p>
                    </label>
                    <input type="file" id="fileInputMain" accept=".json" onchange="loadAccount(event)">
                    <p class="file-name-main" id="fileNameMain"></p>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="showCreateAccount()">
                        Crear Cuenta
                    </button>
                </div>
            </div>

            <!-- Pantalla crear cuenta -->
            <div id="createScreen" class="screen">
                <h2>Crear Nueva Cuenta</h2>
                
                <div class="form-group">
                    <label for="username">Nombre de Usuario</label>
                    <input type="text" id="username" placeholder="Ingresa tu nombre" maxlength="20">
                </div>

                <div class="avatar-section">
                    <label>Elige tu Avatar</label>
                    <div class="avatar-container">
                        <div class="avatar-scroll" id="avatarGrid"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="createAccount()">
                        Comenzar
                    </button>
                    <button class="btn btn-back" onclick="showMainScreen()">
                        Volver
                    </button>
                </div>
            </div>

            <!-- Pantalla cargar cuenta -->
            <div id="loadScreen" class="screen">
                <h2>Cargar Cuenta</h2>
                
                <div class="file-upload-section">
                    <p class="instruction-text">Selecciona tu archivo JSON para continuar</p>
                    <label for="fileInput" class="file-label">
                        Seleccionar Archivo
                    </label>
                    <input type="file" id="fileInput" accept=".json" onchange="loadAccount(event)">
                    <p class="file-name" id="fileName"></p>
                </div>

                <div class="button-group">
                    <button class="btn btn-back" onclick="showMainScreen()">
                        Volver
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const avatarCount = 10;

        let selectedAvatar = null;

        function generateAvatars() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = '';

            for (let i = 1; i <= avatarCount; i++) {
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar-item';
                avatarDiv.onclick = () => selectAvatar(i, avatarDiv);

                avatarDiv.innerHTML = `<img src="resources/avatars/Avatar-${i}.png" alt="Avatar ${i}">`;

                grid.appendChild(avatarDiv);
            }
        }

        function selectAvatar(index, element) {
            document.querySelectorAll('.avatar-item').forEach(item => {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedAvatar = index;
        }

        function showMainScreen() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('mainScreen').classList.add('active');
            document.querySelector('.login-box').classList.remove('expanded');
        }

        function showCreateAccount() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('createScreen').classList.add('active');
            document.querySelector('.login-box').classList.add('expanded');
            generateAvatars();
        }

        function showLoadAccount() {
            // Ya no se usa esta función
        }

        function createAccount() {
            const username = document.getElementById('username').value.trim();

            if (!username) {
                alert('Por favor ingresa un nombre de usuario');
                return;
            }

            if (selectedAvatar === null) {
                alert('Por favor selecciona un avatar');
                return;
            }

            const profile = {
                username: username,
                avatar: selectedAvatar,
                createdAt: new Date().toISOString(),
                stats: {
                    totalGames: 0,
                    normalGames: 0,
                    infiniteGames: 0,
                    totalPoints: 0,
                    bestScoreNormal: 0,
                    bestScoreInfinite: 0,
                    totalCorrect: 0,
                    totalWrong: 0
                },
                achievements: []
            };

            localStorage.setItem('pruebaris_profile', JSON.stringify(profile));
            downloadProfile(profile);
            window.location.href = 'pruebaris.html';
        }

        function loadAccount(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileNameDisplay = document.getElementById('fileNameMain') || document.getElementById('fileName');
            if (fileNameDisplay) {
                fileNameDisplay.textContent = `Archivo seleccionado: ${file.name}`;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const profile = JSON.parse(e.target.result);

                    if (!profile.username || !profile.stats) {
                        alert('Archivo JSON inválido');
                        if (fileNameDisplay) fileNameDisplay.textContent = '';
                        return;
                    }

                    localStorage.setItem('pruebaris_profile', JSON.stringify(profile));
                    window.location.href = 'pruebaris.html';
                } catch (error) {
                    alert('Error al cargar el archivo. Asegúrate de que sea un JSON válido de Pruebaris.');
                    if (fileNameDisplay) fileNameDisplay.textContent = '';
                }
            };
            reader.readAsText(file);
        }

        // Drag and drop functionality
        const dropArea = document.querySelector('.file-drop-area');
        
        if (dropArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.add('highlight');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => {
                    dropArea.classList.remove('highlight');
                }, false);
            });

            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    document.getElementById('fileInputMain').files = files;
                    loadAccount({ target: { files: files } });
                }
            }
        }

        function downloadProfile(profile) {
            const dataStr = JSON.stringify(profile, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `pruebaris_${profile.username}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>